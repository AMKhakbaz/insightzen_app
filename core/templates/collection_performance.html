{% extends 'base.html' %}
{% load static %}
{% block title %}{% if lang == 'fa' %}کارایی گردآوری{% else %}Collection Performance{% endif %}{% endblock %}

{#
  Enhanced collection performance dashboard

  This template renders a fully interactive dashboard for monitoring
  telephone interviewer performance.  Users can filter by date range,
  project and interviewer; the charts update dynamically via Ajax
  requests.  A donut chart illustrates the share of interviews per
  interviewer within a project; a bar chart shows overall totals and
  successes; a line chart tracks daily totals; and a table lists
  interviewers ranked by performance with sortable columns.  An
  export button triggers an Excel download including a raw call log.
  All strings are localised using ``lang``.
%}

{% block content %}
<div class="card" style="max-width:1200px;margin:2rem auto;padding:1.5rem;">
    <h1 style="margin-bottom:1rem;">{% if lang == 'fa' %}کارایی گردآوری{% else %}Collection Performance{% endif %}</h1>
    <p class="card-intro">
        {% if lang == 'fa' %}پس از پایان ددلاین هر پروژه، فقط مالک می‌تواند این داشبورد را مشاهده کند.{% else %}After a project's deadline passes, only the owner can review this dashboard.{% endif %}
    </p>
    <div class="filters" style="display:flex;flex-wrap:wrap;gap:1rem;margin-bottom:1rem;">
        <div style="min-width:220px;">
            <label for="project-select">{% if lang == 'fa' %}پروژه{% else %}Project{% endif %}</label><br>
            <select id="project-select" class="form-select" multiple style="min-width:220px;max-height:150px;">
                {% for p in projects %}
                    <option value="{{ p.pk }}" {% if p.pk in filters.project_ids %}selected{% endif %}>{{ p.name }}</option>
                {% endfor %}
            </select>
            <small class="form-hint">
                {% if lang == 'fa' %}
                    برای انتخاب چند پروژه کلیدهای Ctrl (یا Cmd در مک) را نگه دارید؛ خالی گذاشتن یعنی همه پروژه‌ها.
                {% else %}
                    Hold Ctrl (or Cmd on macOS) to choose multiple projects, or leave empty for all.
                {% endif %}
            </small>
        </div>
        <div>
            <label for="start-date">{% if lang == 'fa' %}از{% else %}From{% endif %}</label><br>
            <input type="datetime-local" id="start-date" class="form-control" value="{{ filters.start|default:'' }}">
        </div>
        <div>
            <label for="end-date">{% if lang == 'fa' %}تا{% else %}To{% endif %}</label><br>
            <input type="datetime-local" id="end-date" class="form-control" value="{{ filters.end|default:'' }}">
        </div>
        <div>
            <label for="user-select">{% if lang == 'fa' %}پرسشگران{% else %}Interviewers{% endif %}</label><br>
            <select id="user-select" class="form-select" multiple style="min-width:200px;max-height:130px;">
                {% for u in users %}
                    <option value="{{ u.pk }}" {% if u.pk in filters.user_ids %}selected{% endif %}>{{ u.first_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div style="display:flex;align-items:flex-end;">
            <button id="export-btn" class="btn btn-secondary" type="button" style="height:38px;">
                {% if lang == 'fa' %}خروجی اکسل{% else %}Export Excel{% endif %}
            </button>
        </div>
    </div>
    <div class="chart-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem;margin-bottom:1.5rem;">
        <div class="chart-container" style="height:320px;">
            <canvas id="bar-chart" data-url="{% url 'collection_performance_data' %}" data-total-label="{% if lang == 'fa' %}کل{% else %}Total{% endif %}" data-success-label="{% if lang == 'fa' %}موفق{% else %}Successful{% endif %}"></canvas>
        </div>
        <div class="chart-container" style="height:320px;">
            <canvas id="donut-chart" data-url="{% url 'collection_performance_data' %}"></canvas>
        </div>
        <div class="chart-container" style="height:320px;grid-column:1/-1;">
            <canvas id="line-chart" data-url="{% url 'collection_performance_data' %}" data-total-label="{% if lang == 'fa' %}کل{% else %}Total{% endif %}" data-success-label="{% if lang == 'fa' %}موفق{% else %}Successful{% endif %}"></canvas>
        </div>
    </div>
    <div class="top-table">
        <h2 style="margin-bottom:0.5rem;">{% if lang == 'fa' %}۵ پرسشگر برتر{% else %}Top Interviewers{% endif %}</h2>
        <div class="table-responsive">
            <table id="top5-table" class="table" data-table="interactive" data-empty-text="{% if lang == 'fa' %}داده‌ای برای نمایش نیست.{% else %}No interviewers match your filters.{% endif %}" data-search-text="{% if lang == 'fa' %}در حال جست‌وجو…{% else %}Searching…{% endif %}">
                <thead>
                    <tr>
                        <th scope="col">
                            <button type="button" class="table-sort" data-sort-column="0" data-sort-type="text">
                                <span>{% if lang == 'fa' %}پروژه{% else %}Project{% endif %}</span>
                                <span class="sort-icon" aria-hidden="true"></span>
                            </button>
                        </th>
                        <th scope="col">
                            <button type="button" class="table-sort" data-sort-column="1" data-sort-type="text">
                                <span>{% if lang == 'fa' %}کاربر{% else %}User{% endif %}</span>
                                <span class="sort-icon" aria-hidden="true"></span>
                            </button>
                        </th>
                        <th scope="col">
                            <button type="button" class="table-sort" data-sort-column="2" data-sort-type="number">
                                <span>{% if lang == 'fa' %}کل تماس‌ها{% else %}Total Calls{% endif %}</span>
                                <span class="sort-icon" aria-hidden="true"></span>
                            </button>
                        </th>
                        <th scope="col">
                            <button type="button" class="table-sort" data-sort-column="3" data-sort-type="number">
                                <span>{% if lang == 'fa' %}موفق{% else %}Successful{% endif %}</span>
                                <span class="sort-icon" aria-hidden="true"></span>
                            </button>
                        </th>
                        <th scope="col">
                            <button type="button" class="table-sort" data-sort-column="4" data-sort-type="number">
                                <span>{% if lang == 'fa' %}نرخ موفقیت{% else %}Success Rate{% endif %}</span>
                                <span class="sort-icon" aria-hidden="true"></span>
                            </button>
                        </th>
                    </tr>
                    <tr class="table-filter-row">
                        <th><input type="text" data-filter-column="0" placeholder="{% if lang == 'fa' %}نام پروژه{% else %}Project{% endif %}" autocomplete="off"></th>
                        <th><input type="text" data-filter-column="1" placeholder="{% if lang == 'fa' %}نام کاربر{% else %}User{% endif %}" autocomplete="off"></th>
                        <th><input type="text" data-filter-column="2" data-filter-type="number" placeholder="{% if lang == 'fa' %}عدد یا >۱۰{% else %}Number or >10{% endif %}" autocomplete="off"></th>
                        <th><input type="text" data-filter-column="3" data-filter-type="number" placeholder="{% if lang == 'fa' %}عدد یا <۵{% else %}Number or <5{% endif %}" autocomplete="off"></th>
                        <th><input type="text" data-filter-column="4" data-filter-type="number" placeholder="{% if lang == 'fa' %}٪ یا >۵۰{% else %}% or >50{% endif %}" autocomplete="off"></th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows populated by charts.js -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Handle Excel export.  Build the export URL using a separate
// variable to avoid nested quotes in template tags.  When the user
// clicks the export button, construct a query string from the
// selected filters and open the download in a new tab.
document.addEventListener('DOMContentLoaded', function () {
    const exportBtn = document.getElementById('export-btn');
    if (!exportBtn) return;
    const exportUrl = "{% url 'collection_performance_export' %}";
    exportBtn.addEventListener('click', function () {
        const params = new URLSearchParams();
        const projectSelect = document.getElementById('project-select');
        const start = document.getElementById('start-date').value;
        const end = document.getElementById('end-date').value;
        const userSelect = document.getElementById('user-select');
        const selectedProjects = projectSelect ? Array.from(projectSelect.selectedOptions).map(function (o) { return o.value; }).filter(function (v) { return v; }) : [];
        const selectedUsers = Array.from(userSelect.selectedOptions).map(function (o) { return o.value; }).filter(function (v) { return v; });
        if (selectedProjects.length) params.append('projects', selectedProjects.join(','));
        if (start) params.append('start_date', start);
        if (end) params.append('end_date', end);
        if (selectedUsers.length) params.append('users', selectedUsers.join(','));
        const url = params.toString() ? (exportUrl + '?' + params.toString()) : exportUrl;
        window.open(url, '_blank');
    });
});
</script>

{% endblock %}

{% block extra_scripts %}
    {{ block.super }}
    <script src="{% static 'core/js/charts.js' %}"></script>
{% endblock %}