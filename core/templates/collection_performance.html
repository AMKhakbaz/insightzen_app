{% extends 'base.html' %}
{% load static %}
{% block title %}{% if lang == 'fa' %}Ú©Ø§Ø±Ø§ÛŒÛŒ Ú¯Ø±Ø¯Ø¢ÙˆØ±ÛŒ{% else %}Collection Performance{% endif %}{% endblock %}

{#
  Enhanced collection performance dashboard

  This template renders a fully interactive dashboard for monitoring
  telephone interviewer performance.  Users can filter by date range,
  project and interviewer; the charts update dynamically via Ajax
  requests.  A donut chart illustrates the share of interviews per
  interviewer within a project; a bar chart shows overall totals and
  successes; a line chart tracks daily totals; and a table lists
  interviewers ranked by performance with sortable columns.  An
  export button triggers an Excel download including a raw call log.
  All strings are localised using ``lang``.
%}

{% block content %}
<div class="card" style="max-width:1200px;margin:2rem auto;padding:1.5rem;">
    <h1 style="margin-bottom:1rem;">{% if lang == 'fa' %}Ú©Ø§Ø±Ø§ÛŒÛŒ Ú¯Ø±Ø¯Ø¢ÙˆØ±ÛŒ{% else %}Collection Performance{% endif %}</h1>
    <p class="card-intro">
        {% if lang == 'fa' %}Ù¾Ø³ Ø§Ø² Ù¾Ø§ÛŒØ§Ù† Ø¯Ø¯Ù„Ø§ÛŒÙ† Ù‡Ø± Ù¾Ø±ÙˆÚ˜Ù‡ØŒ ÙÙ‚Ø· Ù…Ø§Ù„Ú© Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø§ÛŒÙ† Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø±Ø§ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†Ø¯.{% else %}After a project's deadline passes, only the owner can review this dashboard.{% endif %}
    </p>
    <style>
        .filters-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: start;
        }
        .filter-field {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            background: var(--color-surface-muted);
            border: 1px solid var(--color-border);
            border-radius: 0.75rem;
            padding: 0.75rem 0.85rem;
        }
        .filter-label {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-weight: var(--font-weight-medium);
        }
        .input-shell {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 0.6rem;
            padding: 0.35rem 0.55rem;
        }
        .input-shell:focus-within {
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px var(--color-accent-soft);
        }
        .input-shell .input-prefix {
            color: var(--color-text-muted);
            font-size: 0.95em;
            white-space: nowrap;
        }
        .input-shell select,
        .input-shell input {
            background: transparent;
            border: none;
            color: var(--color-text);
            width: 100%;
            padding: 0.35rem 0.15rem;
        }
        .input-shell select:focus,
        .input-shell input:focus {
            outline: none;
        }
        .selection-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }
        .selection-chip {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 999px;
            padding: 0.15rem 0.55rem;
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
        }
        .table-section-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 0.75rem;
        }
        .table-section-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .table-export-status {
            display: block;
            margin-top: 0.35rem;
            color: var(--color-text-muted);
            font-size: var(--font-size-sm);
        }
        .table-export-status.is-success { color: var(--color-success, #1b8755); }
        .table-export-status.is-error { color: var(--color-danger, #c53030); }
        .table-export-status.is-info { color: var(--color-accent, #0d6efd); }
    </style>

    <div class="kpi-grid" aria-live="polite">
        <div class="kpi-card">
            <p class="kpi-label">{% if lang == 'fa' %}Ú©Ù„ ØªÙ…Ø§Ø³â€ŒÙ‡Ø§{% else %}Total Calls{% endif %}</p>
            <p class="kpi-value" id="kpi-total-interviews">â€”</p>
        </div>
        <div class="kpi-card">
            <p class="kpi-label">{% if lang == 'fa' %}ØªÙ…Ø§Ø³â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙÙ‚{% else %}Successful Calls{% endif %}</p>
            <p class="kpi-value" id="kpi-successful-interviews">â€”</p>
        </div>
        <div class="kpi-card">
            <p class="kpi-label">{% if lang == 'fa' %}Ù†Ø±Ø® Ù…ÙˆÙÙ‚ÛŒØª{% else %}Success Rate{% endif %}</p>
            <p class="kpi-value" id="kpi-success-rate">â€”</p>
        </div>
        <div class="kpi-card kpi-card--metrics">
            <p class="kpi-label">{% if lang == 'fa' %}Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù…Ø¯Øª Ùˆ Ø§ÙˆØ¬ Ø²Ù…Ø§Ù†ÛŒ{% else %}Avg Duration & Peak Hour{% endif %}</p>
            <p class="kpi-value" id="kpi-average-duration">â€”</p>
            <p class="kpi-subvalue" id="kpi-duration-sample">{% if lang == 'fa' %}Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª{% else %}No duration data{% endif %}</p>
            <p class="kpi-subvalue" id="kpi-peak-hour">â€”</p>
        </div>
    </div>
    <div class="top-table" style="margin-top:1.25rem;">
        <div class="table-section-header">
            <div>
                <h2 id="top-table-title" style="margin:0;" data-label-fa="{count} Ù¾Ø±Ø³Ø´Ú¯Ø± Ø¨Ø±ØªØ±" data-label-en="Top {count} Interviewers">{% if lang == 'fa' %}Ù¾Ø±Ø³Ø´Ú¯Ø±Ø§Ù† Ø¨Ø±ØªØ±{% else %}Top Interviewers{% endif %}</h2>
                <p class="card-intro" style="margin:0.35rem 0 0 0;">
                    {% if lang == 'fa' %}
                        Ø¨Ø±ØªØ±ÛŒÙ† Ø§Ø¬Ø±Ø§Ú©Ù†Ù†Ø¯Ú¯Ø§Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ ØªÙ…Ø§Ø³ Ùˆ Ù†Ø±Ø® Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ù…Ø­Ø¯ÙˆØ¯Ù‡Ù” ÙÛŒÙ„ØªØ± Ø´Ø¯Ù‡.
                    {% else %}
                        Leading interviewers by total calls and success rate within the active filters.
                    {% endif %}
                </p>
            </div>
            <div class="table-section-actions">
                <button type="button" class="btn btn-outline" data-table-export-target="top5-table" data-export-format="xlsx">
                    {% if lang == 'fa' %}Ø§Ú©Ø³Ù„{% else %}Excel{% endif %}
                </button>
                <button type="button" class="btn btn-outline" data-table-export-target="top5-table" data-export-format="csv">
                    {% if lang == 'fa' %}CSV{% else %}CSV{% endif %}
                </button>
            </div>
        </div>
        <span class="table-export-status" id="top-table-status" data-table-export-status="top5-table" role="status" aria-live="polite"></span>
        <div class="table-responsive">
            <table id="top5-table" class="table" data-table="interactive" data-filter-context="collection_performance_top" data-top-limit="5" data-empty-text="{% if lang == 'fa' %}Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª.{% else %}No interviewers match your filters.{% endif %}" data-search-text="{% if lang == 'fa' %}Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³Øªâ€ŒÙˆØ¬Ùˆâ€¦{% else %}Searchingâ€¦{% endif %}" data-export-endpoint="{% url 'table_export' %}" data-export-filename="collection-top" data-export-param-limit="5" data-export-placement="header" data-export-status-target="top-table-status">
                <thead>
                    <tr>
                        <th scope="col">
                            <button type="button" class="table-sort" data-sort-column="0" data-sort-type="text">
                                <span>{% if lang == 'fa' %}Ù¾Ø±ÙˆÚ˜Ù‡{% else %}Project{% endif %}</span>
                                <span class="sort-icon" aria-hidden="true"></span>
                            </button>
                        </th>
                        <th scope="col">
                            <button type="button" class="table-sort" data-sort-column="1" data-sort-type="text">
                                <span>{% if lang == 'fa' %}Ú©Ø§Ø±Ø¨Ø±{% else %}User{% endif %}</span>
                                <span class="sort-icon" aria-hidden="true"></span>
                            </button>
                        </th>
                        <th scope="col">
                            <button type="button" class="table-sort" data-sort-column="2" data-sort-type="number">
                                <span>{% if lang == 'fa' %}Ú©Ù„ ØªÙ…Ø§Ø³â€ŒÙ‡Ø§{% else %}Total Calls{% endif %}</span>
                                <span class="sort-icon" aria-hidden="true"></span>
                            </button>
                        </th>
                        <th scope="col">
                            <button type="button" class="table-sort" data-sort-column="3" data-sort-type="number">
                                <span>{% if lang == 'fa' %}Ù…ÙˆÙÙ‚{% else %}Successful{% endif %}</span>
                                <span class="sort-icon" aria-hidden="true"></span>
                            </button>
                        </th>
                        <th scope="col">
                            <button type="button" class="table-sort" data-sort-column="4" data-sort-type="number">
                                <span>{% if lang == 'fa' %}Ù†Ø±Ø® Ù…ÙˆÙÙ‚ÛŒØª{% else %}Success Rate{% endif %}</span>
                                <span class="sort-icon" aria-hidden="true"></span>
                            </button>
                        </th>
                    </tr>
                    <tr class="table-filter-row" hidden>
                        <th><input type="text" data-filter-column="0" placeholder="{% if lang == 'fa' %}Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡{% else %}Project{% endif %}" autocomplete="off"></th>
                        <th><input type="text" data-filter-column="1" placeholder="{% if lang == 'fa' %}Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±{% else %}User{% endif %}" autocomplete="off"></th>
                        <th><input type="text" data-filter-column="2" data-filter-type="number" placeholder="{% if lang == 'fa' %}Ø¹Ø¯Ø¯ ÛŒØ§ >Û±Û°{% else %}Number or >10{% endif %}" autocomplete="off"></th>
                        <th><input type="text" data-filter-column="3" data-filter-type="number" placeholder="{% if lang == 'fa' %}Ø¹Ø¯Ø¯ ÛŒØ§ <Ûµ{% else %}Number or <5{% endif %}" autocomplete="off"></th>
                        <th><input type="text" data-filter-column="4" data-filter-type="number" placeholder="{% if lang == 'fa' %}Ùª ÛŒØ§ >ÛµÛ°{% else %}% or >50{% endif %}" autocomplete="off"></th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows populated by charts.js -->
                </tbody>
            </table>
        </div>
    </div>
    <div class="chart-grid">
        <div class="chart-container chart-container--tall">
            <canvas id="bar-chart" data-url="{% url 'collection_performance_data' %}" data-total-label="{% if lang == 'fa' %}Ú©Ù„{% else %}Total{% endif %}" data-success-label="{% if lang == 'fa' %}Ù…ÙˆÙÙ‚{% else %}Successful{% endif %}"></canvas>
        </div>
        <div class="chart-container chart-container--tall">
            <canvas id="donut-chart" data-url="{% url 'collection_performance_data' %}"></canvas>
        </div>
        <div class="chart-container chart-container--compact">
            <canvas id="code-chart" data-url="{% url 'collection_performance_data' %}"></canvas>
        </div>
        <div class="chart-container chart-container--compact">
            <canvas id="hourly-chart" data-url="{% url 'collection_performance_data' %}"></canvas>
        </div>
        <div class="chart-container chart-container--wide">
            <canvas id="line-chart" data-url="{% url 'collection_performance_data' %}" data-total-label="{% if lang == 'fa' %}Ú©Ù„{% else %}Total{% endif %}" data-success-label="{% if lang == 'fa' %}Ù…ÙˆÙÙ‚{% else %}Successful{% endif %}"></canvas>
        </div>
    </div>
    <section id="raw-records" style="margin:1.5rem 0;">
        <div class="table-section-header">
            <div>
                <h2 style="margin:0;">{% if lang == 'fa' %}Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ø®Ø§Ù…{% else %}Raw Interviews{% endif %}</h2>
                <p class="card-intro" style="margin:0.35rem 0 0 0;">
                    {% if lang == 'fa' %}
                        ÙÙ‡Ø±Ø³Øª Ø²ÛŒØ± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ù… Ù…ØµØ§Ø­Ø¨Ù‡ Ø±Ø§ Ø¨Ø§ Ù‡Ù…Ø§Ù† ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ ØµÙØ­Ù‡ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯. Ø¨Ø±Ø§ÛŒ Ø¬Ø³Øªâ€ŒÙˆØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² Ù†ÙˆØ§Ø± Ø§Ø¨Ø²Ø§Ø± Ø¬Ø¯ÙˆÙ„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.
                    {% else %}
                        The table below reflects the raw interview records that match your current filters. Use the table toolbar for quick searches or advanced filters.
                    {% endif %}
                </p>
            </div>
            <div class="table-section-actions">
                <button type="button" class="btn btn-outline" data-table-export-target="raw-records-table" data-export-format="xlsx">
                    {% if lang == 'fa' %}Ø§Ú©Ø³Ù„{% else %}Excel{% endif %}
                </button>
                <button type="button" class="btn btn-outline" data-table-export-target="raw-records-table" data-export-format="csv">
                    {% if lang == 'fa' %}CSV{% else %}CSV{% endif %}
                </button>
            </div>
        </div>
        <span class="table-export-status" id="raw-table-status" data-table-export-status="raw-records-table" role="status" aria-live="polite"></span>
        <div class="table-responsive">
            <table id="raw-records-table" class="table" data-table="interactive" data-filter-context="collection_performance_raw" data-url="{% url 'collection_performance_raw' %}" data-empty-text="{% if lang == 'fa' %}Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.{% else %}No interviews match your filters.{% endif %}" data-search-text="{% if lang == 'fa' %}Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³Øªâ€ŒÙˆØ¬Ùˆâ€¦{% else %}Searchingâ€¦{% endif %}" data-export-endpoint="{% url 'table_export' %}" data-export-filename="collection-raw" data-export-placement="header" data-export-status-target="raw-table-status">
                <thead>
                    <tr>
                        <th scope="col">
                            <button type="button" class="table-sort" data-sort-column="0" data-sort-type="text">
                                <span>{% if lang == 'fa' %}Ù¾Ø±ÙˆÚ˜Ù‡{% else %}Project{% endif %}</span>
                                <span class="sort-icon" aria-hidden="true"></span>
                            </button>
                        </th>
                        <th scope="col">
                            <button type="button" class="table-sort" data-sort-column="1" data-sort-type="text">
                                <span>{% if lang == 'fa' %}Ù¾Ø±Ø³Ø´Ú¯Ø±{% else %}Interviewer{% endif %}</span>
                                <span class="sort-icon" aria-hidden="true"></span>
                            </button>
                        </th>
                        <th scope="col">
                            <button type="button" class="table-sort" data-sort-column="2" data-sort-type="number">
                                <span>{% if lang == 'fa' %}Ú©Ø¯{% else %}Code{% endif %}</span>
                                <span class="sort-icon" aria-hidden="true"></span>
                            </button>
                        </th>
                        <th scope="col">
                            <button type="button" class="table-sort" data-sort-column="3" data-sort-type="text">
                                <span>{% if lang == 'fa' %}ÙˆØ¶Ø¹ÛŒØª{% else %}Status{% endif %}</span>
                                <span class="sort-icon" aria-hidden="true"></span>
                            </button>
                        </th>

                        <th scope="col">
                            <button type="button" class="table-sort" data-sort-column="4" data-sort-type="text">
                                <span>{% if lang == 'fa' %}Ø´Ø±ÙˆØ¹ ÙØ±Ù…{% else %}Form Started{% endif %}</span>
                                <span class="sort-icon" aria-hidden="true"></span>
                            </button>
                        </th>
                        <th scope="col">
                            <button type="button" class="table-sort" data-sort-column="5" data-sort-type="text">
                                <span>{% if lang == 'fa' %}Ù¾Ø§ÛŒØ§Ù† ÙØ±Ù…{% else %}Form Submitted{% endif %}</span>
                                <span class="sort-icon" aria-hidden="true"></span>
                            </button>
                        </th>
                        <th scope="col">
                            <button type="button" class="table-sort" data-sort-column="6" data-sort-type="text">
                                <span>{% if lang == 'fa' %}Ø«Ø¨Øª{% else %}Logged{% endif %}</span>
                                <span class="sort-icon" aria-hidden="true"></span>
                            </button>
                        </th>
                    </tr>
                    <tr class="table-filter-row" hidden>
                        <th><input type="text" data-filter-column="0" placeholder="{% if lang == 'fa' %}Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡{% else %}Project{% endif %}" autocomplete="off"></th>
                        <th><input type="text" data-filter-column="1" placeholder="{% if lang == 'fa' %}Ù†Ø§Ù… Ù¾Ø±Ø³Ø´Ú¯Ø±{% else %}Interviewer{% endif %}" autocomplete="off"></th>
                        <th><input type="text" data-filter-column="2" data-filter-type="number" placeholder="{% if lang == 'fa' %}Ú©Ø¯{% else %}Code{% endif %}" autocomplete="off"></th>
                        <th><input type="text" data-filter-column="3" placeholder="{% if lang == 'fa' %}ÙˆØ¶Ø¹ÛŒØª{% else %}Status{% endif %}" autocomplete="off"></th>
                        <th><input type="text" data-filter-column="4" placeholder="{% if lang == 'fa' %}Ù…Ø«Ø§Ù„: 2024-01-01{% else %}e.g. 2024-01-01{% endif %}" autocomplete="off"></th>
                        <th><input type="text" data-filter-column="5" placeholder="{% if lang == 'fa' %}Ù…Ø«Ø§Ù„: 2024-01-01{% else %}e.g. 2024-01-01{% endif %}" autocomplete="off"></th>
                        <th><input type="text" data-filter-column="6" placeholder="{% if lang == 'fa' %}ØªØ§Ø±ÛŒØ®{% else %}Date{% endif %}" autocomplete="off"></th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Raw rows populated dynamically -->
                </tbody>
            </table>
        </div>
        <div class="table-pagination" id="raw-pagination" style="margin-top:1rem;">
            <div class="page-size-control">
                <label for="raw-page-size" style="margin:0;">{% if lang == 'fa' %}ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø± Ù‡Ø± ØµÙØ­Ù‡{% else %}Rows per page{% endif %}</label>
                <select id="raw-page-size">
                    <option value="30">30</option>
                    <option value="50">50</option>
                    <option value="200">200</option>
                </select>
            </div>
            <div class="page-info" id="raw-page-info" style="color:var(--color-text-muted);font-size:var(--font-size-sm);">
                {% if lang == 'fa' %}Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦{% else %}Loadingâ€¦{% endif %}
            </div>
            <div class="page-controls">
                <button type="button" class="btn btn-outline" id="raw-page-prev">{% if lang == 'fa' %}Ù‚Ø¨Ù„ÛŒ{% else %}Previous{% endif %}</button>
                <span id="raw-results-status" style="color:var(--color-text-muted);font-size:var(--font-size-sm);"></span>
                <button type="button" class="btn btn-outline" id="raw-page-next">{% if lang == 'fa' %}Ø¨Ø¹Ø¯ÛŒ{% else %}Next{% endif %}</button>
            </div>
        </div>
    </section>
    <div class="filters-panel" role="region" aria-label="{% if lang == 'fa' %}ÙÛŒÙ„ØªØ±Ù‡Ø§ Ùˆ Ø®Ø±ÙˆØ¬ÛŒ{% else %}Filters and export{% endif %}" style="margin-top:1.5rem;">
        <div class="filter-field">
            <div class="filter-label">
                <span aria-hidden="true">ğŸ“</span>
                <label for="project-select">{% if lang == 'fa' %}Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§{% else %}Projects{% endif %}</label>
            </div>
            <p class="form-hint" style="margin:0;">
                {% if lang == 'fa' %}
                    Ú†Ù†Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ ÛŒØ§ Ø¨Ø§ ØµÙØ­Ù‡â€ŒÚ©Ù„ÛŒØ¯ Ø¨ÛŒÙ† Ø¢Ù†â€ŒÙ‡Ø§ Ø­Ø±Ú©Øª Ú©Ù†ÛŒØ¯Ø› Ø®Ø§Ù„ÛŒ Ú¯Ø°Ø§Ø´ØªÙ† ÛŒØ¹Ù†ÛŒ Ù‡Ù…Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§.
                {% else %}
                    Choose one or more projects (keyboard friendly); leave blank to include every project.
                {% endif %}
            </p>
            <div class="input-shell">
                <span class="input-prefix">{% if lang == 'fa' %}ØªÙ…Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§{% else %}All projects{% endif %}</span>
                <select id="project-select" class="form-select" multiple style="min-height:120px;" aria-describedby="project-hint">
                    {% for p in projects %}
                        <option value="{{ p.pk }}" {% if p.pk in filters.project_ids %}selected{% endif %}>{{ p.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="selection-chips" id="project-hint" aria-live="polite">
                {% if filters.project_ids %}
                    {% for p in projects %}
                        {% if p.pk in filters.project_ids %}
                            <span class="selection-chip">{{ p.name }}</span>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <span class="selection-chip">{% if lang == 'fa' %}Ù‡Ù…Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ ÙØ¹Ø§Ù„ Ù‡Ø³ØªÙ†Ø¯{% else %}All projects included{% endif %}</span>
                {% endif %}
            </div>
        </div>
        <div class="filter-field">
            <div class="filter-label">
                <span aria-hidden="true">â±</span>
                <label for="start-date">{% if lang == 'fa' %}Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ{% else %}Date range{% endif %}</label>
            </div>
            <p class="form-hint" style="margin:0;">
                {% if lang == 'fa' %}
                    Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ø¯Ù„Ø®ÙˆØ§Ù‡ Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯Ø› Ø®Ø§Ù„ÛŒ ÛŒØ¹Ù†ÛŒ Ø§Ø² Ø§Ø¨ØªØ¯Ø§ ØªØ§ Ø§Ù…Ø±ÙˆØ².
                {% else %}
                    Set an optional window; leave blank to include all available dates.
                {% endif %}
            </p>
            <div class="input-shell">
                <span class="input-prefix">{% if lang == 'fa' %}Ø§Ø²{% else %}From{% endif %}</span>
                <input type="datetime-local" id="start-date" class="form-control" value="{{ filters.start|default:'' }}" placeholder="2024-01-01 08:00">
            </div>
            <div class="input-shell">
                <span class="input-prefix">{% if lang == 'fa' %}ØªØ§{% else %}To{% endif %}</span>
                <input type="datetime-local" id="end-date" class="form-control" value="{{ filters.end|default:'' }}" placeholder="2024-12-31 17:00">
            </div>
        </div>
        <div class="filter-field">
            <div class="filter-label">
                <span aria-hidden="true">ğŸ‘¥</span>
                <label for="user-select">{% if lang == 'fa' %}Ù¾Ø±Ø³Ø´Ú¯Ø±Ø§Ù†{% else %}Interviewers{% endif %}</label>
            </div>
            <p class="form-hint" style="margin:0;">
                {% if lang == 'fa' %}
                    Ú†Ù†Ø¯ Ù¾Ø±Ø³Ø´Ú¯Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ ÛŒØ§ Ø¨Ø§ ØµÙØ­Ù‡â€ŒÚ©Ù„ÛŒØ¯ Ø¨ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø­Ø±Ú©Øª Ú©Ù†ÛŒØ¯Ø› Ø®Ø§Ù„ÛŒ ÛŒØ¹Ù†ÛŒ Ù‡Ù…Ù‡ Ù¾Ø±Ø³Ø´Ú¯Ø±Ø§Ù†.
                {% else %}
                    Pick one or many interviewers (keyboard friendly); leave empty to include every caller.
                {% endif %}
            </p>
            <div class="input-shell">
                <span class="input-prefix">{% if lang == 'fa' %}Ù‡Ù…Ù‡{% else %}All{% endif %}</span>
                <select id="user-select" class="form-select" multiple style="min-height:120px;" aria-describedby="user-hint">
                    {% for u in users %}
                        <option value="{{ u.pk }}" {% if u.pk in filters.user_ids %}selected{% endif %}>{{ u.first_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="selection-chips" id="user-hint" aria-live="polite">
                {% if filters.user_ids %}
                    {% for u in users %}
                        {% if u.pk in filters.user_ids %}
                            <span class="selection-chip">{{ u.first_name }}</span>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <span class="selection-chip">{% if lang == 'fa' %}Ù‡Ù…Ù‡ Ù¾Ø±Ø³Ø´Ú¯Ø±Ø§Ù† ÙØ¹Ø§Ù„ Ù‡Ø³ØªÙ†Ø¯{% else %}All interviewers included{% endif %}</span>
                {% endif %}
            </div>
        </div>
        <div class="filter-field" style="justify-content:space-between;gap:0.75rem;">
            <div>
                <div class="filter-label">
                    <span aria-hidden="true">â¬‡ï¸</span>
                    <span>{% if lang == 'fa' %}Ø¯Ø±ÛŒØ§ÙØª Ø®Ø±ÙˆØ¬ÛŒ{% else %}Export options{% endif %}</span>
                </div>
                <p class="form-hint" style="margin:0;">
                    {% if lang == 'fa' %}
                        Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„ Ø¨Ø§ Ø±Ø¹Ø§ÛŒØª ØªÙ…Ø§Ù… ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ ÙØ¹Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
                    {% else %}
                        Download an Excel extract that respects all active filters.
                    {% endif %}
                </p>
            </div>
            <button id="export-btn" class="btn btn-secondary" type="button" style="width:100%;">
                {% if lang == 'fa' %}Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„{% else %}Export Excel{% endif %}
            </button>
        </div>
    </div>
</div>

<script>
// Handle Excel export.  Build the export URL using a separate
// variable to avoid nested quotes in template tags.  When the user
// clicks the export button, construct a query string from the
// selected filters and open the download in a new tab.
document.addEventListener('DOMContentLoaded', function () {
    const exportBtn = document.getElementById('export-btn');
    if (!exportBtn) return;
    const exportUrl = "{% url 'collection_performance_export' %}";
    exportBtn.addEventListener('click', function () {
        const params = new URLSearchParams();
        const projectSelect = document.getElementById('project-select');
        const start = document.getElementById('start-date').value;
        const end = document.getElementById('end-date').value;
        const userSelect = document.getElementById('user-select');
        const selectedProjects = projectSelect ? Array.from(projectSelect.selectedOptions).map(function (o) { return o.value; }).filter(function (v) { return v; }) : [];
        const selectedUsers = Array.from(userSelect.selectedOptions).map(function (o) { return o.value; }).filter(function (v) { return v; });
        if (selectedProjects.length) params.append('projects', selectedProjects.join(','));
        if (start) params.append('start_date', start);
        if (end) params.append('end_date', end);
        if (selectedUsers.length) params.append('users', selectedUsers.join(','));
        const url = params.toString() ? (exportUrl + '?' + params.toString()) : exportUrl;
        window.open(url, '_blank');
    });
});
</script>

{% endblock %}

{% block extra_scripts %}
    {{ block.super }}
    <script src="{% static 'core/js/charts.js' %}"></script>
{% endblock %}
