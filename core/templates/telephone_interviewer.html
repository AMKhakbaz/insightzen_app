{% extends 'base.html' %}
{% block title %}{% if lang == 'fa' %}مصاحبه تلفنی{% else %}Telephone Interviewer{% endif %}{% endblock %}

{% block content %}
<div class="card" style="max-width:800px;margin:2rem auto;">
    <h1 style="margin-bottom:1rem;">{% if lang == 'fa' %}مصاحبه تلفنی{% else %}Telephone Interviewer{% endif %}</h1>
    <p class="card-intro">
        {% if lang == 'fa' %}دسترسی به این پنل پس از پایان ددلاین فقط برای مالک پروژه فعال می‌ماند.{% else %}After the project deadline, only the owner can continue using this panel.{% endif %}
    </p>
    <!-- Project selection -->
    <div style="margin-bottom:1rem;display:flex;align-items:center;gap:1rem;flex-wrap:wrap;">
        <label for="project-select">{% if lang == 'fa' %}پروژه:{% else %}Project:{% endif %}</label>
        <select id="project-select" class="form-select" style="min-width:280px;">
            <option value="" disabled {% if not selected_project %}selected{% endif %}>{% if lang == 'fa' %}انتخاب پروژه{% else %}Select Project{% endif %}</option>
            {% for p in projects %}
                <option value="{{ p.pk }}" {% if selected_project and p.pk == selected_project.pk %}selected{% endif %}>{{ p.name }}</option>
            {% endfor %}
        </select>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const projSel = document.getElementById('project-select');
        if (projSel) {
            projSel.addEventListener('change', function() {
                const val = this.value;
                if (val) {
                    window.location.href = '?project=' + val;
                }
            });
        }
    });
    </script>
    {% if selected_project %}
        <div class="sample-upload-guide" style="margin-bottom:1rem;">
            <strong>{% if lang == 'fa' %}منبع نمونه: {% else %}Sample source:{% endif %}</strong>
            {% if sample_source == 'upload' %}
                <span>
                    {% if lang == 'fa' %}
                        این پروژه از فایل اکسل اختصاصی استفاده می‌کند. برای بروزرسانی لیست، از بخش تنظیمات پروژه فایل جدید را بارگذاری کنید.
                    {% else %}
                        This project draws from an uploaded Excel workbook. Upload a fresh file from the project settings whenever the calling list changes.
                    {% endif %}
                </span>
                <div style="margin-top:0.35rem;font-size:0.85rem;">
                    {% if sample_metadata.accepted_rows %}
                        {% if lang == 'fa' %}
                            {{ sample_metadata.accepted_rows }} ردیف معتبر از {{ sample_metadata.total_rows }} ردیف شناسایی شده است (آخرین بروزرسانی {{ selected_project.sample_upload_refreshed_at|date:'Y-m-d H:i'|default:'—' }}).
                        {% else %}
                            {{ sample_metadata.accepted_rows }} of {{ sample_metadata.total_rows }} rows passed validation (last refresh {{ selected_project.sample_upload_refreshed_at|date:'Y-m-d H:i'|default:'—' }}).
                        {% endif %}
                    {% else %}
                        {% if lang == 'fa' %}فایلی بارگذاری نشده است یا ردیف معتبری یافت نشد.{% else %}No valid rows were found in the uploaded file yet.{% endif %}
                    {% endif %}
                </div>
                <div style="margin-top:0.35rem;font-size:0.85rem;">
                    {% if lang == 'fa' %}ستون‌های موردنیاز: {% else %}Required headers:{% endif %}
                    {% for header in required_headers %}
                        <code>{{ header }}</code>{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </div>
            {% else %}
                <span>
                    {% if lang == 'fa' %}
                        نمونه تماس از بانک پاسخگوی مرکزی انتخاب می‌شود و به صورت خودکار تکمیل می‌گردد.
                    {% else %}
                        Numbers rotate from the respondent bank and replenish automatically as quotas progress.
                    {% endif %}
                </span>
            {% endif %}
        </div>
        <div class="sample-upload-guide" style="margin-bottom:1rem;">
            <strong>{% if lang == 'fa' %}کدهای وضعیت:{% else %}Status codes:{% endif %}</strong>
            {% if call_result_mode == 'custom' %}
                <span>
                    {% if lang == 'fa' %}این پروژه از کدهای سفارشی استفاده می‌کند که در فایل CSV/اکسل بارگذاری‌شده تعریف شده‌اند.{% else %}This project relies on a custom CSV/Excel upload that defines the call outcomes.{% endif %}
                </span>
            {% elif call_result_selection == 'custom' %}
                <span>
                    {% if lang == 'fa' %}کدهای پیش‌فرض سیستم در حال استفاده هستند زیرا فایل سفارشی یافت نشد. لطفاً در بخش تنظیمات پروژه فایل معتبر بارگذاری کنید.{% else %}The default system codes are being used because a valid custom upload was not found. Please upload a valid file in the project settings.{% endif %}
                </span>
            {% else %}
                <span>
                    {% if lang == 'fa' %}کدهای پیش‌فرض InsightZen برای تشخیص موفقیت تماس استفاده می‌شوند.{% else %}The built-in InsightZen codes determine whether a call is successful.{% endif %}
                </span>
            {% endif %}
            <div style="margin-top:0.35rem;font-size:0.85rem;">
                {% if lang == 'fa' %}ستون‌های لازم برای فایل سفارشی: {% else %}Required headers for custom files:{% endif %}
                {% for header in call_result_headers %}
                    <code>{{ header }}</code>{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </div>
        </div>
    {% endif %}
    {% if selected_project %}
        {% if person and mobile %}
        <form method="post">
            {% csrf_token %}
            {% if call_sample %}
                <input type="hidden" name="call_sample_id" value="{{ call_sample.id }}">
            {% endif %}
            {% if uploaded_sample %}
                <input type="hidden" name="uploaded_sample_id" value="{{ uploaded_sample.id }}">
            {% endif %}
                {% if start_form %}
                    <input type="hidden" name="start_form" value="{{ start_form }}">
                {% endif %}
            <div style="margin-bottom:1rem;">
                <div style="margin-bottom:0.5rem;"><strong>{% if lang == 'fa' %}نام:{% else %}Name:{% endif %}</strong> {{ person.full_name }}</div>
                <div style="margin-bottom:0.5rem;"><strong>{% if lang == 'fa' %}شماره تلفن:{% else %}Phone:{% endif %}</strong> {{ mobile }}</div>
            </div>
            <div style="margin-bottom:0.5rem;">
                <label>{% if lang == 'fa' %}کد وضعیت{% else %}Status Code{% endif %}</label>
                <select name="code" class="form-select" required style="min-width:220px;">
                    <option value="" disabled selected>{% if lang == 'fa' %}انتخاب کد{% else %}Select Code{% endif %}</option>
                    {% for i,status in status_codes.items %}
                        <option value="{{ i }}">{{ i }} - {{ status }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="margin-bottom:0.5rem;">
                <label>{% if lang == 'fa' %}جنسیت{% else %}Gender{% endif %}</label>
                <select name="gender" class="form-select" style="min-width:220px;">
                    <option value="" {% if not prefill_gender %}selected{% endif %}>{% if lang == 'fa' %}انتخاب{% else %}Select{% endif %}</option>
                    <option value="male" {% if prefill_gender == 'male' %}selected{% endif %}>{% if lang == 'fa' %}آقا{% else %}Male{% endif %}</option>
                    <option value="female" {% if prefill_gender == 'female' %}selected{% endif %}>{% if lang == 'fa' %}خانم{% else %}Female{% endif %}</option>
                </select>
            </div>
            <div style="margin-bottom:0.5rem;display:flex;flex-wrap:wrap;gap:1rem;">
                <div>
                    <label>{% if lang == 'fa' %}سن{% else %}Age{% endif %}</label>
                    <input type="number" name="age" class="form-control" style="width:120px;" min="0" max="120" value="{{ prefill_age|default_if_none:'' }}">
                </div>
                <div>
                    <label>{% if lang == 'fa' %}سال تولد{% else %}Birth Year{% endif %}</label>
                    <input type="number" name="birth_year" class="form-control" style="width:120px;" min="1900" max="2100" value="{{ prefill_birth_year|default_if_none:'' }}">
                </div>
                <div>
                    <label>{% if lang == 'fa' %}شهر{% else %}City{% endif %}</label>
                    <input type="text" name="city" class="form-control" style="width:160px;" value="{{ prefill_city|default_if_none:'' }}">
                </div>
            </div>
            <button type="submit" class="btn" style="margin-top:0.5rem;">{% if lang == 'fa' %}ثبت{% else %}Submit{% endif %}</button>
        </form>
        {% else %}
            {% if sample_source == 'upload' %}
                <p>{% if lang == 'fa' %}فایلی حاوی شماره تماس در این پروژه یافت نشد. لطفاً در صفحه ویرایش پروژه فایل اکسل شامل ستون‌های {{ required_headers|join:', ' }} را بارگذاری کنید.{% else %}No uploaded contacts are available for this project. Please upload an Excel file with the required headers ({{ required_headers|join:', ' }}) from the project settings.{% endif %}</p>
            {% else %}
                <p>{% if lang == 'fa' %}موردی برای تماس یافت نشد.{% else %}No available respondent found for the selected project.{% endif %}</p>
            {% endif %}
        {% endif %}
    {% else %}
        <p>{% if lang == 'fa' %}پروژه‌ای انتخاب نشده است.{% else %}Please select a project to start interviewing.{% endif %}</p>
    {% endif %}
</div>
{% endblock %}