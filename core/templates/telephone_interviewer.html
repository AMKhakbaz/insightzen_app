{% extends 'base.html' %}
{% block title %}{% if lang == 'fa' %}مصاحبه تلفنی{% else %}Telephone Interviewer{% endif %}{% endblock %}

{% block content %}
<div class="card" style="max-width:800px;margin:2rem auto;">
    <h1 style="margin-bottom:1rem;">{% if lang == 'fa' %}مصاحبه تلفنی{% else %}Telephone Interviewer{% endif %}</h1>
    <p class="card-intro">
        {% if lang == 'fa' %}دسترسی به این پنل پس از پایان ددلاین فقط برای مالک پروژه فعال می‌ماند.{% else %}After the project deadline, only the owner can continue using this panel.{% endif %}
    </p>
    <!-- Project selection -->
    <div style="margin-bottom:1rem;display:flex;align-items:center;gap:1rem;flex-wrap:wrap;">
        <label for="project-select">{% if lang == 'fa' %}پروژه:{% else %}Project:{% endif %}</label>
        <select id="project-select" class="form-select" style="min-width:280px;">
            <option value="" disabled {% if not selected_project %}selected{% endif %}>{% if lang == 'fa' %}انتخاب پروژه{% else %}Select Project{% endif %}</option>
            {% for p in projects %}
                <option value="{{ p.pk }}" {% if selected_project and p.pk == selected_project.pk %}selected{% endif %}>{{ p.name }}</option>
            {% endfor %}
        </select>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const projSel = document.getElementById('project-select');
        if (projSel) {
            projSel.addEventListener('change', function() {
                const val = this.value;
                if (val) {
                    window.location.href = '?project=' + val;
                }
            });
        }
    });
    </script>
    {% if selected_project and sample_source == 'upload' %}
        <div style="margin-bottom:1rem;">
            <a class="btn btn-secondary btn-sm" href="{% url 'project_dataset_append' selected_project.pk %}">
                {% if lang == 'fa' %}افزودن داده جدید{% else %}Append Dataset{% endif %}
            </a>
        </div>
    {% endif %}
    {% if selected_project %}
        {% if person and mobile %}
        <form method="post">
            {% csrf_token %}
            {% if call_sample %}
                <input type="hidden" name="call_sample_id" value="{{ call_sample.id }}">
            {% endif %}
            {% if uploaded_sample %}
                <input type="hidden" name="uploaded_sample_id" value="{{ uploaded_sample.id }}">
            {% endif %}
                {% if start_form %}
                    <input type="hidden" name="start_form" value="{{ start_form }}">
                {% endif %}
            <div style="margin-bottom:1rem;">
                <div style="margin-bottom:0.5rem;"><strong>{% if lang == 'fa' %}نام:{% else %}Name:{% endif %}</strong> {{ person.full_name }}</div>
                <div style="margin-bottom:0.5rem;"><strong>{% if lang == 'fa' %}شماره تلفن:{% else %}Phone:{% endif %}</strong> {{ mobile }}</div>
            </div>
            <div style="margin-bottom:0.5rem;">
                <label>{% if lang == 'fa' %}کد وضعیت{% else %}Status Code{% endif %}</label>
                <select name="code" class="form-select" required style="min-width:220px;">
                    <option value="" disabled selected>{% if lang == 'fa' %}انتخاب کد{% else %}Select Code{% endif %}</option>
                    {% for i,status in status_codes.items %}
                        <option value="{{ i }}">{{ i }} - {{ status }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="margin-bottom:0.5rem;">
                <label>{% if lang == 'fa' %}جنسیت{% else %}Gender{% endif %}</label>
                <select name="gender" class="form-select" style="min-width:220px;">
                    <option value="" {% if not prefill_gender %}selected{% endif %}>{% if lang == 'fa' %}انتخاب{% else %}Select{% endif %}</option>
                    <option value="male" {% if prefill_gender == 'male' %}selected{% endif %}>{% if lang == 'fa' %}آقا{% else %}Male{% endif %}</option>
                    <option value="female" {% if prefill_gender == 'female' %}selected{% endif %}>{% if lang == 'fa' %}خانم{% else %}Female{% endif %}</option>
                </select>
            </div>
            <div style="margin-bottom:0.5rem;display:flex;flex-wrap:wrap;gap:1rem;">
                <div>
                    <label>{% if lang == 'fa' %}سن{% else %}Age{% endif %}</label>
                    <input type="number" name="age" class="form-control" style="width:120px;" min="0" max="120" value="{{ prefill_age|default_if_none:'' }}">
                </div>
                <div>
                    <label>{% if lang == 'fa' %}سال تولد (جلالی){% else %}Birth Year (Jalali){% endif %}</label>
                    <input type="number" name="birth_year" class="form-control" style="width:120px;" min="1300" max="1410" value="{{ prefill_birth_year|default_if_none:'' }}">
                </div>
                <div>
                    <label>{% if lang == 'fa' %}شهر{% else %}City{% endif %}</label>
                    <input type="text" name="city" class="form-control" style="width:160px;" value="{{ prefill_city|default_if_none:'' }}">
                </div>
            </div>
            <button type="submit" class="btn" style="margin-top:0.5rem;">{% if lang == 'fa' %}ثبت{% else %}Submit{% endif %}</button>
            <script>
            document.addEventListener('DOMContentLoaded', function() {
                const ageInput = document.querySelector('input[name="age"]');
                const birthInput = document.querySelector('input[name="birth_year"]');
                if (!ageInput || !birthInput) {
                    return;
                }

                const AGE_MIN = 0;
                const AGE_MAX = 120;
                const BIRTH_MIN = 1300;
                const BIRTH_MAX = 1410;
                const digitMap = {
                    '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4',
                    '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9'
                };
                const persianYearFormatter = new Intl.DateTimeFormat('fa-IR-u-ca-persian', { year: 'numeric' });
                const currentPersianYear = parseInt(
                    persianYearFormatter.format(new Date()).replace(/[۰-۹]/g, function(digit) {
                        return digitMap[digit] || digit;
                    }),
                    10
                );

                let isSyncing = false;

                function clamp(value, min, max) {
                    return Math.min(Math.max(value, min), max);
                }

                function normalizeInputValue(inputEl, min, max) {
                    const raw = inputEl.value.trim();
                    if (!raw) {
                        return null;
                    }
                    const numeric = parseInt(raw, 10);
                    if (isNaN(numeric)) {
                        return null;
                    }
                    const clamped = clamp(numeric, min, max);
                    if (clamped !== numeric) {
                        inputEl.value = clamped;
                    }
                    return clamped;
                }

                function syncFromAge() {
                    if (isSyncing) {
                        return;
                    }
                    const normalizedAge = normalizeInputValue(ageInput, AGE_MIN, AGE_MAX);
                    if (normalizedAge === null) {
                        return;
                    }
                    isSyncing = true;
                    const birthYear = clamp(currentPersianYear - normalizedAge, BIRTH_MIN, BIRTH_MAX);
                    birthInput.value = birthYear;
                    isSyncing = false;
                }

                function syncFromBirth() {
                    if (isSyncing) {
                        return;
                    }
                    const normalizedBirth = normalizeInputValue(birthInput, BIRTH_MIN, BIRTH_MAX);
                    if (normalizedBirth === null) {
                        return;
                    }
                    isSyncing = true;
                    const age = clamp(currentPersianYear - normalizedBirth, AGE_MIN, AGE_MAX);
                    ageInput.value = age;
                    isSyncing = false;
                }

                ['input', 'change'].forEach(function(evt) {
                    ageInput.addEventListener(evt, syncFromAge);
                    birthInput.addEventListener(evt, syncFromBirth);
                });

                if (birthInput.value.trim()) {
                    syncFromBirth();
                } else if (ageInput.value.trim()) {
                    syncFromAge();
                }
            });
            </script>
        </form>
        {% else %}
            {% if sample_source == 'upload' %}
                <p>{% if lang == 'fa' %}فایلی حاوی شماره تماس در این پروژه یافت نشد. لطفاً با استفاده از گزینه «افزودن داده جدید» فایل اکسل شامل ستون‌های {{ required_headers|join:', ' }} را بارگذاری کنید.{% else %}No uploaded contacts are available for this project. Use the “Append Dataset” action to upload an Excel file with the required headers ({{ required_headers|join:', ' }}).{% endif %}</p>
            {% else %}
                <p>{% if lang == 'fa' %}موردی برای تماس یافت نشد.{% else %}No available respondent found for the selected project.{% endif %}</p>
            {% endif %}
        {% endif %}
    {% else %}
        <p>{% if lang == 'fa' %}پروژه‌ای انتخاب نشده است.{% else %}Please select a project to start interviewing.{% endif %}</p>
    {% endif %}
</div>
{% endblock %}