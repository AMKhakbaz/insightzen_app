{% extends 'base.html' %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="card" style="max-width:900px;margin:2rem auto;">
    <h1>{% if lang == 'fa' %}
        {% if title == 'Add User to Project' %}افزودن کاربر به پروژه{% elif title == 'Edit Membership' %}ویرایش دسترسی کاربر{% else %}دسترسی{% endif %}
    {% else %}
        {{ title }}
    {% endif %}</h1>
    {% if form.emails and not form.emails.is_hidden %}
    <div class="form-hint" style="margin-bottom:1rem;">
        <p><strong>English:</strong> Enter one or more email addresses separated by commas or new lines. Each address will receive the same project access and panel flags.</p>
    </div>
    {% endif %}
    <form method="post" id="membership-form">
        {% csrf_token %}
        {{ form.non_field_errors }}
        {% if form.emails.is_hidden %}
            {{ form.emails }}
        {% else %}
        {# Emails field #}
        <div>
            {{ form.emails.label_tag }}
            {{ form.emails }}
            {{ form.emails.errors }}
            {% if form.emails.help_text %}
                <small class="form-hint">{{ form.emails.help_text }}</small>
            {% endif %}
        </div>
        {% endif %}
        {# Project field #}
        <div>
            {{ form.project.label_tag }}
            {{ form.project }}
            {{ form.project.errors }}
        </div>
        {# Membership title field #}
        <div class="membership-title-field">
            {{ form.title.label_tag }}
            <div class="membership-title-inputs">
                {{ form.title }}
                {% if lang == 'fa' %}
                    <small class="form-hint">یکی از عناوین پیشنهادی را انتخاب کنید یا گزینه سایر را برای ورود عنوان دلخواه برگزینید.</small>
                {% else %}
                    <small class="form-hint">Choose a suggested title or select Other to enter a custom label.</small>
                {% endif %}
                {{ form.title.errors }}
            </div>
            <div class="membership-title-custom" data-title-custom-wrapper {% if form.title.value != '__custom__' %}hidden{% endif %}>
                <label for="id_title_custom">
                    {% if lang == 'fa' %}عنوان دلخواه{% else %}Custom title{% endif %}
                </label>
                {{ form.title_custom }}
                {{ form.title_custom.errors }}
            </div>
        </div>
        <div class="form-check membership-owner-field">
            {{ form.is_owner }}
            <label for="id_is_owner">
                {% if lang == 'fa' %}مالک پروژه{% else %}Project owner{% endif %}
            </label>
            {{ form.is_owner.errors }}
        </div>
        {# Panel permissions grouped by category.  Each group has a
           master checkbox that toggles all child checkboxes. #}
        <fieldset style="margin-top:1rem;">
            <legend style="color:var(--primary);">{% if lang == 'fa' %}دسترسی‌ها{% else %}Panel Access{% endif %}</legend>
            <div style="display:flex;flex-wrap:wrap;gap:1.5rem;">
                <div>
                    <label style="font-weight:600;display:flex;align-items:center;gap:0.5rem;">
                        <input type="checkbox" class="group-toggle" data-group="database_quota">
                        <span>{% if lang == 'fa' %}پایگاه داده و سهمیه{% else %}DB & Quota{% endif %}</span>
                    </label>
                    <div style="margin-top:0.5rem;">
                        <label>{{ form.database_management }} {% if lang == 'fa' %}مدیریت پایگاه داده{% else %}Database Management{% endif %}</label><br>
                        <label>{{ form.quota_management }} {% if lang == 'fa' %}مدیریت سهمیه{% else %}Quota Management{% endif %}</label>
                    </div>
                </div>
                <div>
                    <label style="font-weight:600;display:flex;align-items:center;gap:0.5rem;">
                        <input type="checkbox" class="group-toggle" data-group="collection">
                        <span>{% if lang == 'fa' %}گردآوری{% else %}Collection{% endif %}</span>
                    </label>
                    <div style="margin-top:0.5rem;">
                        <label>{{ form.collection_management }} {% if lang == 'fa' %}مدیریت گردآوری{% else %}Collection Management{% endif %}</label><br>
                        <label>{{ form.collection_performance }} {% if lang == 'fa' %}کارایی گردآوری{% else %}Collection Performance{% endif %}</label><br>
                        <label>{{ form.telephone_interviewer }} {% if lang == 'fa' %}مصاحبه تلفنی{% else %}Telephone Interviewer{% endif %}</label><br>
                        <label>{{ form.fieldwork_interviewer }} {% if lang == 'fa' %}مصاحبه میدانی{% else %}Fieldwork Interviewer{% endif %}</label><br>
                        <label>{{ form.focus_group_panel }} {% if lang == 'fa' %}پنل گروه کانونی{% else %}Focus Group Panel{% endif %}</label>
                    </div>
                </div>
                <div>
                    <label style="font-weight:600;display:flex;align-items:center;gap:0.5rem;">
                        <input type="checkbox" class="group-toggle" data-group="data_access">
                        <span>{% if lang == 'fa' %}دسترسی داده{% else %}Data Access{% endif %}</span>
                    </label>
                    <div style="margin-top:0.5rem;">
                        <label>{{ form.review_data }} {% if lang == 'fa' %}بازبینی داده{% else %}Review Data{% endif %}</label><br>
                        <label>{{ form.edit_data }} {% if lang == 'fa' %}ویرایش داده{% else %}General Edit{% endif %}</label>
                    </div>
                </div>
                <div>
                    <label style="font-weight:600;display:flex;align-items:center;gap:0.5rem;">
                        <input type="checkbox" class="group-toggle" data-group="quality">
                        <span>{% if lang == 'fa' %}کنترل کیفیت{% else %}Quality Control{% endif %}</span>
                    </label>
                    <div style="margin-top:0.5rem;">
                        <label>{{ form.qc_management }} {% if lang == 'fa' %}مدیریت QC{% else %}QC Management{% endif %}</label><br>
                        <label>{{ form.qc_performance }} {% if lang == 'fa' %}کارایی QC{% else %}QC Performance{% endif %}</label><br>
                        <label>{{ form.voice_review }} {% if lang == 'fa' %}بازبینی صدا{% else %}Voice Review{% endif %}</label><br>
                        <label>{{ form.callback_qc }} {% if lang == 'fa' %}QC تماس برگشتی{% else %}Callback QC{% endif %}</label>
                    </div>
                </div>
                <div>
                    <label style="font-weight:600;display:flex;align-items:center;gap:0.5rem;">
                        <input type="checkbox" class="group-toggle" data-group="analysis">
                        <span>{% if lang == 'fa' %}تحلیل{% else %}Analysis & AI{% endif %}</span>
                    </label>
                    <div style="margin-top:0.5rem;">
                        <label>{{ form.coding }} {% if lang == 'fa' %}کدگذاری{% else %}Coding{% endif %}</label><br>
                        <label>{{ form.product_matrix_ai }} {% if lang == 'fa' %}ماتریس محصول AI{% else %}Product Matrix AI{% endif %}</label><br>
                        <label>{{ form.statistical_health_check }} {% if lang == 'fa' %}بررسی سلامت آماری{% else %}Statistical Health Check{% endif %}</label><br>
                        <label>{{ form.tabulation }} {% if lang == 'fa' %}جدول‌بندی{% else %}Tabulation{% endif %}</label><br>
                        <label>{{ form.statistics }} {% if lang == 'fa' %}آمار{% else %}Statistics{% endif %}</label><br>
                        <label>{{ form.funnel_analysis }} {% if lang == 'fa' %}تحلیل قیف{% else %}Funnel Analysis{% endif %}</label><br>
                        <label>{{ form.conjoint_analysis }} {% if lang == 'fa' %}تحلیل همگرایی{% else %}Conjoint Analysis{% endif %}</label><br>
                        <label>{{ form.segmentation_analysis }} {% if lang == 'fa' %}تحلیل تقسیم‌بندی{% else %}Segmentation Analysis{% endif %}</label>
                    </div>
                </div>
            </div>
        </fieldset>
        <button type="submit" class="btn" style="margin-top:1rem;">
            {% if lang == 'fa' %}
                {% if title == 'Add User' %}افزودن{% else %}ذخیره{% endif %}
            {% else %}
                {% if title == 'Add User' %}Add{% else %}Save{% endif %}
            {% endif %}
        </button>
    </form>

    {% if workbook_form %}
    <section class="membership-upload-panel" style="margin-top:2rem;">
        <h2>{% if lang == 'fa' %}بارگذاری فایل اکسل اعضا{% else %}Upload Membership Excel{% endif %}</h2>
        <p class="form-hint" style="font-size:0.95rem;color:var(--muted);margin-top:0.25rem;">
            Download the latest workbook, update the rows, and upload the edited file to replace or add memberships in bulk.
        </p>
        <div style="display:flex;gap:1rem;flex-wrap:wrap;align-items:center;margin-bottom:1rem;">
            <a class="btn btn-outline" href="{{ workbook_template_url }}" target="_blank" rel="noopener">
                {% if lang == 'fa' %}دانلود اکسل{% else %}Download Excel{% endif %}
            </a>
            <span class="form-hint">
                {% if lang == 'fa' %}فایل باید با فرمت .xlsx یا .xls باشد.{% else %}Accepted formats: .xlsx or .xls.{% endif %}
            </span>
        </div>
        <form method="post" action="{% url 'membership_import_workbook' %}" enctype="multipart/form-data" class="membership-upload-form">
            {% csrf_token %}
            <div>
                {{ workbook_form.workbook.label_tag }}
                {{ workbook_form.workbook }}
                {{ workbook_form.workbook.errors }}
            </div>
            <button type="submit" class="btn" style="margin-top:1rem;">{% if lang == 'fa' %}بارگذاری اکسل{% else %}Upload Workbook{% endif %}</button>
        </form>
    </section>
    {% endif %}

    <script>
    // Group toggle behaviour: when a group master checkbox is clicked,
    // toggle all child checkboxes within that group.  Each group is
    // identified via a data-group attribute on the master.  Child
    // checkboxes have names that correspond to group prefixes defined
    // in the template.  The mapping is hard coded here to avoid
    // querying the DOM repeatedly.
    document.addEventListener('DOMContentLoaded', function() {
        const titleSelect = document.getElementById('id_title');
        const customWrapper = document.querySelector('[data-title-custom-wrapper]');
        const customInput = document.getElementById('id_title_custom');

        const syncTitleVisibility = function() {
            if (!titleSelect || !customWrapper || !customInput) {
                return;
            }
            if (titleSelect.value === '__custom__') {
                customWrapper.hidden = false;
                customInput.disabled = false;
            } else {
                customWrapper.hidden = true;
                customInput.disabled = true;
                customInput.value = '';
            }
        };

        syncTitleVisibility();
        if (titleSelect) {
            titleSelect.addEventListener('change', syncTitleVisibility);
        }

        const groupMap = {
            'database_quota': ['database_management','quota_management'],
            'collection': ['collection_management','collection_performance','telephone_interviewer','fieldwork_interviewer','focus_group_panel'],
            'data_access': ['review_data','edit_data'],
            'quality': ['qc_management','qc_performance','voice_review','callback_qc'],
            'analysis': ['coding','product_matrix_ai','statistical_health_check','tabulation','statistics','funnel_analysis','conjoint_analysis','segmentation_analysis'],
        };
        document.querySelectorAll('.group-toggle').forEach(function(master) {
            master.addEventListener('change', function() {
                const group = master.getAttribute('data-group');
                const fields = groupMap[group] || [];
                fields.forEach(function(name) {
                    const cb = document.getElementById('id_' + name);
                    if (cb) cb.checked = master.checked;
                });
            });
        });
    });
    </script>
</div>
{% endblock %}